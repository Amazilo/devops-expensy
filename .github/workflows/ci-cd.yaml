name: Expensy CI/CD

on:
  push:
    branches: [main]

env:
  DOCKER_USER: amazilo
  BACKEND_IMAGE: amazilo/expensy-backend:latest
  FRONTEND_IMAGE: amazilo/expensy-frontend:latest
  RESOURCE_GROUP: myAKSAmaziloRG
  CLUSTER_NAME: myAKSAmaziloCluster
  NAMESPACE: default

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ‚¨áÔ∏è Checkout code
      uses: actions/checkout@v3

    - name: üîê Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: ÔøΩÔøΩ Build and push backend
      run: |
        docker build -t $BACKEND_IMAGE ./devops-expensy/expensy_backend
        docker push $BACKEND_IMAGE

    - name: üê≥ Build and push frontend
      run: |
        docker build -t $FRONTEND_IMAGE ./devops-expensy/expensy_frontend
        docker push $FRONTEND_IMAGE

    - name: ‚òÅÔ∏è Azure login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ‚òÅÔ∏è Get AKS credentials
      run: |
        az aks get-credentials --resource-group $RESOURCE_GROUP --name $CLUSTER_NAME

    - name: üöÄ Deploy backend to AKS
      run: |
        kubectl set image deployment/backend backend=$BACKEND_IMAGE -n $NAMESPACE

    - name: üöÄ Deploy frontend to AKS
      run: |
        kubectl set image deployment/frontend frontend=$FRONTEND_IMAGE -n $NAMESPACE

